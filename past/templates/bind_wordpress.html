{% extends "layout.html" %}

{% import "blocks.html" as blocks %}

{% block content_block %}
    <div id="sidebar"></div>
    <div id="rightbar">
        {{blocks.rightbar_intros_block(intros)}}
        <div class="sep10"></div>
        {{blocks.rightbar_feedback_block()}}
    </div>

    <div id="middlebar">
        <!--提醒-->
        {{ blocks.notification_block() }}

        <!--绑定wordpress-->
        <div class="box">
            <div class="cell"><a href="/i">首页</a> &gt; 绑定wordpress</div>
        {% if step == '1'%}
            <div id="feed1" class="cell"><table>
                <tr height="40px">
                    <td width="200px" align="right"><span class="fade">你的wordpress feed地址：</span></td>
                    <td width="280px" align="left">
                        <input type="text" class="sl" name="wordpress_feed" value=""></input>
                        <div class="sep3"></div>
                        <span class="tip smaller">比如: http://xxblog.com/feed/, 填写后不可更改</span> 
                    </td>
                </tr>
                <tr height="30px"><td align="right"><span class="fade"></span></td>
                    <td> <input type="submit" name="bind_wordpress" value="确定"></input> </td>
                </tr>
            </table></div>

            <div id="feed2" class="inner" style="display:none;">
                <span id="feed2_0" style="display:none;"></span>
                你的wordpress feed地址为：<span id="feed2_1"></span>
                <div class="sep10"></div>
                <span id="feed2_2"></span>
                <div class="sep10"></div>
                <input type="submit" name="confirm_bind_wordpress" value="下一步"></input>
            </div>
        {%else%}
            <div id="feed2" class="inner">
                你的blog feed地址为：<span id="feed2_1" class="fade">{{feed_uri}}</span>
                <div class="sep10"></div>
                你的blog认领验证码为：<span id="feed2_0" class="fade">{{random_id}}</span>
                <div class="sep10"></div>
                为了验证blog的主人^^，请发一篇blog，内容为 {{random_id}}，完成该步骤后，请点下一步完成绑定
                <div class="sep3"></div>

                <input type="submit" name="confirm_bind_wordpress" value="下一步"></input>
            </div>
        {%endif%}

            <div class="inner">
            1. 每个人只能认领一个blog^^
            <div class="sep3"></div>
            2. 理论来说，支持导入所有的rss feed，而不仅仅是wordpress
            <div class="sep3"></div>
            3. 对于wordpress rss feed来讲，只能导入最近的15篇文章，如果需要导入更多，需要去wordpress的控制面板中设置rss输出的文章数目。
            <div class="sep3"></div>
            </div>

        </div>
    </div>

    <script language="javascript">
        jQuery(function($) {
            $("input[name='bind_wordpress']").bind("click", function(){
                var feed_uri = $("input[name='wordpress_feed']").val();
                $.post("/bind/wordpress", {'step':1, 'feed_uri':feed_uri}, function(data){
                    if(data.ok == 'true'){
                        $("#feed1").hide();
                        $("#feed2").show();
                        $("#feed2_0").text(data.code);
                        $("#feed2_1").text(data.feed_uri);
                        $("#feed2_2").text(data.msg);
                    }else{
                        alert(data.msg);
                    }
                }, "json");
                return false;
            });

            var c = $("input[name='confirm_bind_wordpress']");
            c.bind("click", function(){
                c.val("正在验证中... 可能需要1分钟，请不要刷新页面");
                $.post("/bind/wordpress", {'step':2, 'random_id': $("#feed2_0").text()}, function(data){
                    c.val("下一步");
                    if(data.ok === 'true'){
                        alert(data.msg);
                        window.location = "/settings";
                    }else{
                        alert(data.msg + "," + "你是否还没有发含有验证码的文章呀？^^");
                    }
                }, 'json');
            });

        });
    </script>

{% endblock %}
